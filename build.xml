<project name="CDK" default="compile" basedir=".">

        <property name="build.compiler" value="modern" />
        <property name="build" value="build" />
        <property name="sourcedist" value="sourcedist" />
        <property name="dist" value="dist" />
        <property name="doc" value="doc" />
	<property name="src" value="src" />
	<property name="lib" value="jar" />
        <property name="src.tests" value="${src}/org/openscience/cdk/test" />
        <property name="reports.tests" value="reports" />
        <property name="pathtojava3d" value="" />
        <property name="pathtojoelib" value="../../JoeLib/joelib/" />

        <path id="project.class.path">
                <pathelement
                location="/usr/lib/j2sdk1.3/jre/lib/rt.jar" />

                <pathelement location="." />
                <fileset dir="${lib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${pathtojava3d}">
                        <include name="*.jar" />
                </fileset>
        </path>

        <target name="init">
                <tstamp />
		<mkdir dir="${doc}/api" />
                <mkdir dir="${build}" />
                <mkdir dir="${sourcedist}" />
                <mkdir dir="${dist}" />
                <mkdir dir="${reports.tests}" />
        </target>

        <target name="clean">
                <delete>
                        <fileset dir="." includes="**/*~" />
                        <fileset dir="." includes="**/*.class" />
                        <fileset dir="." includes="*.tar.gz" />
                        <fileset dir="." includes="*.zip" />
                </delete>

                <delete dir="${build}" />
                <delete dir="${sourcedist}" />
                <delete dir="${reports.tests}" />
        </target>
	
        <target name="compile" depends="init">
                <echo message="Compiling only the classes that don't use Java3d." />

                <echo
                message="Use 'compile-with-java3d' target for full Java3D support. " />

                <mkdir dir="${build}" />

                <javac destdir="${build}" optimize="off" debug="on" deprecation="off">
                        <src path="${src}" />
                        <exclude name="${sourcedist}/**" />
                        <exclude
                        name="org/openscience/cdk/applications/Viewer.java" />
                        <exclude
                        name="org/openscience/cdk/renderer/AcceleratedRenderer3D*" />
                        <exclude
                        name="org/openscience/cdk/renderer/OrbitalsRenderer3D*" />
                        <exclude
                        name="org/openscience/cdk/test/AcceleratedRenderer3DTest.java" />
                        <exclude
                        name="org/openscience/cdk/test/OrbitalsRenderer3DTest.java" />
                        <exclude
                        name="org/openscience/cdk/test/VisualGaussiansCalculationTest.java" />
                        <exclude
                        name="org/openscience/cdk/test/ZMatrixReaderTest.java" />

                        <!-- exclude libio classes that require additional
                             libraries, and are compiled elsewhere -->
                        <exclude name="org/openscience/cdk/libio/**" />

                        <classpath refid="project.class.path" />
                </javac>

                <copy todir="${build}">
                        <fileset dir="${src}" includes="**/Test-*" />
                </copy>
        </target>

        <target name="compile-libio" depends="init">
                <!-- Task to build to libio classes. Clearly, this requires extra
                     extra jars, and these should be located in ${lib}/libio -->

                <javac destdir="${build}" optimize="off" debug="on" deprecation="off">
                        <src path="${src}/org/openscience/cdk/libio" />

                        <classpath refid="project.class.path" />
                        <classpath>
                               <fileset dir="${lib}/libio">
                                       <include name="*.jar" />
                               </fileset>
                        </classpath>
                </javac>
        </target>

        <target name="compile-with-java3d" depends="init">
                <mkdir dir="${build}" />

                <javac destdir="${build}" optimize="on" deprecation="off" debug="on">
                        <src path="${src}" />

                        <!-- exclude libio classes that require additional
                             libraries, and are compiled elsewhere -->
                        <exclude name="org/openscience/cdk/libio/**" />

                        <classpath refid="project.class.path" />
                </javac>
        </target>

        <target name="dist.init">
                <mkdir dir="${dist}/jar" />

                <mkdir
                dir="${build}/org/openscience/cdk/config" />

                <copy
                file="${src}/org/openscience/cdk/config/isotopes.xml"
                tofile="${build}/org/openscience/cdk/config/isotopes.xml" />
                <copy
                file="${src}/org/openscience/cdk/config/structgen_atomtypes.xml"
                tofile="${build}/org/openscience/cdk/config/structgen_atomtypes.xml" />
                <copy
                file="${src}/org/openscience/cdk/config/log4j.properties"
                tofile="${build}/org/openscience/cdk/config/log4j.properties" />

                <mkdir
                dir="${build}/org/openscience/cdk/io/cml/data" />

                <copy
                file="${src}/org/openscience/cdk/io/cml/data/cml1_0.dtd"
                tofile="${build}/org/openscience/cdk/io/cml/data/cml1_0.dtd" />
                <copy
                file="${src}/org/openscience/cdk/io/cml/data/cml1_0_1.dtd"
                tofile="${build}/org/openscience/cdk/io/cml/data/cml1_0_1.dtd" />
        </target>

        <target name="dist-core" depends="compile, dist.init">
                <jar jarfile="${dist}/jar/cdk-core.jar">
                    <fileset dir="${build}">
                        <!-- As proposed in CDK-RFC 2 -->
                        <include name="org/openscience/cdk/AtomContainer.class" />
                        <include name="org/openscience/cdk/AtomEnumeration.class" />
                        <include name="org/openscience/cdk/Atom.class" />
                        <include name="org/openscience/cdk/AtomType.class" />
                        <include name="org/openscience/cdk/BioPolymer.class" />
                        <include name="org/openscience/cdk/Bond.class" />
                        <include name="org/openscience/cdk/ChemModel.class" />
                        <include name="org/openscience/cdk/ChemObject.class" />
                        <include name="org/openscience/cdk/ChemSequence.class" />
                        <include name="org/openscience/cdk/ElectronContainer.class" />
                        <include name="org/openscience/cdk/Element.class" />
                        <include name="org/openscience/cdk/Isotope.class" />
                        <include name="org/openscience/cdk/Molecule.class" />
                        <include name="org/openscience/cdk/Monomer.class" />
                        <include name="org/openscience/cdk/Polymer.class" />
                        <include name="org/openscience/cdk/Ring.class" />
                        <include name="org/openscience/cdk/RingSet.class" />
                        <include name="org/openscience/cdk/SetOfMolecules.class" />
                   </fileset>
                </jar>
        </target>

        <target name="dist-extra" depends="dist-core">
                <jar jarfile="${dist}/jar/cdk-extra.jar">
                    <fileset dir="${build}">
                        <include name="**/cdk/**" />
                        <!-- Exclude core classes -->
                        <exclude name="org/openscience/cdk/AtomContainer.class" />
                        <exclude name="org/openscience/cdk/AtomEnumeration.class" />
                        <exclude name="org/openscience/cdk/Atom.class" />
                        <exclude name="org/openscience/cdk/AtomType.class" />
                        <exclude name="org/openscience/cdk/BioPolymer.class" />
                        <exclude name="org/openscience/cdk/Bond.class" />
                        <exclude name="org/openscience/cdk/ChemModel.class" />
                        <exclude name="org/openscience/cdk/ChemObject.class" />
                        <exclude name="org/openscience/cdk/ChemSequence.class" />
                        <exclude name="org/openscience/cdk/ElectronContainer.class" />
                        <exclude name="org/openscience/cdk/Element.class" />
                        <exclude name="org/openscience/cdk/Isotope.class" />
                        <exclude name="org/openscience/cdk/Molecule.class" />
                        <exclude name="org/openscience/cdk/Monomer.class" />
                        <exclude name="org/openscience/cdk/Polymer.class" />
                        <exclude name="org/openscience/cdk/Ring.class" />
                        <exclude name="org/openscience/cdk/RingSet.class" />
                        <exclude name="org/openscience/cdk/SetOfMolecules.class" />
                        <!-- Exclude libio classes -->
                        <exclude name="org/openscience/cdk/libio/**" />
                   </fileset>
                </jar>
        </target>

        <target name="dist-libio" depends="compile-libio">
                <jar jarfile="${dist}/jar/cdk-libio.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/libio/**" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-cml" depends="dist-core">
                <jar jarfile="${dist}/jar/cdk-cml.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/io/cml/**" />
                        <include name="org/openscience/cdk/io/cml/cdopi/**" />
                        <include name="org/openscience/cdk/tools/LoggingTool*" />
                        <include name="org/openscience/cdk/config/log4j.properties" />
                    </fileset>
                </jar>
        </target>

        <target name="dist" depends="dist-extra" />

        <target name="dist-with-java3d" depends="compile-with-java3d, dist-core">
                <jar jarfile="${dist}/jar/cdk-extra-with-java3d.jar">
                    <fileset dir="${build}">
                        <include name="**/cdk/**" />
                        <!-- Exclude core classes -->
                        <exclude name="org/openscience/cdk/AtomContainer.class" />
                        <exclude name="org/openscience/cdk/AtomEnumeration.class" />
                        <exclude name="org/openscience/cdk/Atom.class" />
                        <exclude name="org/openscience/cdk/AtomType.class" />
                        <exclude name="org/openscience/cdk/BioPolymer.class" />
                        <exclude name="org/openscience/cdk/Bond.class" />
                        <exclude name="org/openscience/cdk/ChemModel.class" />
                        <exclude name="org/openscience/cdk/ChemObject.class" />
                        <exclude name="org/openscience/cdk/ChemSequence.class" />
                        <exclude name="org/openscience/cdk/ElectronContainer.class" />
                        <exclude name="org/openscience/cdk/Element.class" />
                        <exclude name="org/openscience/cdk/Isotope.class" />
                        <exclude name="org/openscience/cdk/Molecule.class" />
                        <exclude name="org/openscience/cdk/Monomer.class" />
                        <exclude name="org/openscience/cdk/Polymer.class" />
                        <exclude name="org/openscience/cdk/Ring.class" />
                        <exclude name="org/openscience/cdk/RingSet.class" />
                        <exclude name="org/openscience/cdk/SetOfMolecules.class" />
                        <!-- Exclude libio classes -->
                        <exclude name="org/openscience/cdk/libio/**" />
                   </fileset>
                </jar>
        </target>

        <target name="sourcedist" depends="init">
                <copy todir="${sourcedist}">
                        <fileset dir="." includes="**/*java" />
                        <fileset dir="." includes="build.xml" />
                </copy>
                <copy todir="${sourcedist}/org/openscience/cdk/config/isotopes.xml">
                        <fileset dir="org/openscience/cdk/config/"
                                 includes="*" />
                </copy>
                <tar tarfile="cdk-source-${DSTAMP}.tar"
                basedir="${sourcedist}" includes="**" />
                <gzip zipfile="cdk-source-${DSTAMP}.tar.gz"
                src="cdk-source-${DSTAMP}.tar" />
                <delete file="cdk-source-${DSTAMP}.tar" />
                <zip zipfile="cdk-source-${DSTAMP}.zip"
                basedir="${sourcedist}" includes="**" />
        </target>

        <target name="website">
                <java classname="org.apache.xalan.xslt.Process"
                args="-IN ../website.xml -XSL ../lib/cdkwebsite.xsl"
                 dir="doc/source/bin" fork="yes">
                        <classpath>
                                <pathelement
                                location="jar/xerces-1.3.0.jar" />

                                <pathelement
                                location="jar/xalan-2.0.1.jar" />

                                <pathelement
                                location="jar/bsf-2.0.1.jar" />
                        </classpath>
                </java>
        </target>

        <target name="test" depends="clean,dist">
                <junit printsummary="yes" haltonfailure="yes">
                        <classpath>
                                <pathelement
                                location="${dist}/jar/cdk.jar" />

                                <pathelement
                                path="${java.class.path}" />

                                <pathelement location="." />

                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                        <test
                        name="org.openscience.cdk.test.CDKTests"
                        haltonfailure="no"
                        todir="${reports.tests}"
                        outfile="result">
                                <formatter type="plain" />
                        </test>
                </junit>
        </target>

        <target name="run-with-java3d"
        depends="dist-with-java3d">
                <java
                classname="org.openscience.cdk.test.OrbitalsRenderer3DTest"
                 fork="yes">
                        <arg value="data/reserpine.mol" />

                        <classpath>
                                <pathelement location="${dist}/jar/cdk-core.jar" />
                                <pathelement location="${dist}/jar/cdk-extra-with-java3d.jar" />
                                <pathelement path="${java.class.path}" />
                                <pathelement location="." />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                                <fileset dir="${pathto3djava}">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                </java>
        </target>

        <target name="run" depends="dist">
                <java classname="org.openscience.cdk.test.FingerprinterTest" fork="yes">
                        <classpath>
                                <pathelement location="${dist}/jar/cdk-core.jar" />
                                <pathelement location="${dist}/jar/cdk-extra.jar" />
                                <pathelement path="${java.class.path}" />
                                <pathelement location="." />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                </java>
        </target>

        <target name="runLibIOTest" depends="dist">
                <java classname="org.openscience.cdk.libio.joelib.LibIOTest" fork="yes">
                        <classpath>
                                <pathelement location="${dist}/jar/cdk-core.jar" />
                                <pathelement location="${dist}/jar/cdk-extra.jar" />
                                <pathelement location="${dist}/jar/cdk-libio.jar" />
                                <pathelement path="${java.class.path}" />
                                <pathelement location="." />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                                <fileset dir="${lib}/libio">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                </java>
        </target>

    <target name="javadoc" depends="init">
		<javadoc packagenames="org.openscience.cdk.*"
			sourcepath="${src}"
			defaultexcludes="yes"
			destdir="doc/api"
			author="true"
			version="true"
			use="true">
			<classpath refid="project.class.path" />	
		</javadoc>
	</target>
</project>
