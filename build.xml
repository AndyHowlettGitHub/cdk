<project name="CDK" default="compile" basedir=".">

        <!-- compile options -->
        <property name="build.compiler" value="javac1.4" />
        <property name="debug" value="on" />
        <property name="deprecation" value="off" />
        <property name="optimization" value="off" />

        <!-- where to find Java3D -->
        <property name="pathtojava3d" value="" />
        <property name="pathtojoelib" value="../../JoeLib/joelib/" />

        <!-- directories -->
        <property name="build" value="build" />
        <property name="sourcedist" value="sourcedist" />
        <property name="dist" value="dist" />
        <property name="doc" value="doc" />
        <property name="src" value="src" />
        <property name="build.src" value="${build}/${src}" />
        <property name="lib" value="jar" />
        <property name="src.tests" value="${src}/org/openscience/cdk/test" />
        <property name="reports.tests" value="reports" />

        <!-- CLASSPATH -->
        <path id="project.class.path">
                <pathelement
                location="/usr/lib/j2sdk1.3/jre/lib/rt.jar" />

                <pathelement location="." />
                <fileset dir="${lib}">
                        <include name="*.jar" />
                </fileset>
                <fileset dir="${pathtojava3d}">
                        <include name="*.jar" />
                </fileset>
        </path>

        <target name="info">
            <echo message="Using compiler: ${build.compiler}" />
        </target>

        <target name="check">
          <available classname="org.openscience.jmol.Crystal"
                     classpath="${lib}/libio/jmol.jar"
                     property="jmol.present"/>
        </target>

        <target name="init" depends="check">
                <tstamp />
                <mkdir dir="${build}" />
                <mkdir dir="${build.src}" />
                <mkdir dir="${sourcedist}" />
                <mkdir dir="${dist}" />
                <mkdir dir="${reports.tests}" />

                <!-- make a copy of the source tree. Patches are
                     applied to this copy, not the original -->
                <copy todir="${build.src}/org">
                    <fileset dir="${src}/org"/>
                </copy>
        </target>

        <target name="clean">
                <delete>
                        <fileset dir="." includes="**/*~" />
                        <fileset dir="." includes="*.tar.gz" />
                        <fileset dir="." includes="*.zip" />
                </delete>

                <delete dir="${build}" />
                <delete dir="${sourcedist}" />
                <delete dir="${dist}" />
                <delete dir="${reports.tests}" />
        </target>

        <target name="compile">
                <echo message="Compiling only the classes that don't use Java3d."/>
                <echo message="Use 'compile-with-java3d' target for full Java3D support."/>

                <antcall target="compile-all"/>
        </target>

        <target name="compile-with-java3d">
                <antcall target="compile-all"/>
                <antcall target="compile-render-with-java3d"/>
        </target>

        <target name="compile-all" 
            depends="init, info, compile-core, compile-standard, compile-extra, compile-io, 
                     compile-render">
        </target>

        <target name="compile-libio" depends="dist-standard">
                <!-- Task to build the libio classes. Clearly, this requires extra
                     jars, and these should be located in ${lib}/libio -->

                <javac destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}">
                        <src path="${build.src}/org/openscience/cdk/libio" />
                        <src path="${build.src}/org/openscience/cdk/test/libio" />
                        <src path="${build.src}/org/openscience/cdk/applications"/>

                        <classpath refid="project.class.path" />
                        <classpath>
                            <fileset dir="${lib}/libio">
                                <include name="*.jar" />
                            </fileset>
                        </classpath>
                </javac>
        </target>

        <target name="compile-apps" depends="dist-extra, dist-libio">
                <!-- Task to build the applications classes. Some require extra
                     jars, like those in ${lib}/libio -->
                <echo message="Compiling classes defined in ${src}/applications.classes." />

                <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}"
                       includesfile="${src}/applications.classes">

                        <classpath refid="project.class.path" />
                        <classpath>
                               <fileset dir="${lib}/libio">
                                       <include name="*.jar" />
                               </fileset>
                        </classpath>
                </javac>
        </target>

        <target name="compile-core" depends="init">
                <echo message="Compiling classes for cdk-core module." />

                <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}"
                       includesfile="${src}/core.classes">
                    <classpath refid="project.class.path" />
                </javac>
        </target>

        <target name="compile-standard" depends="dist-core">
                <echo message="Compiling classes for cdk-standard module." />

                <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}"
                       includesfile="${src}/standard.classes">
                    <classpath>
                        <fileset dir="${lib}">
                            <include name="JSX1.0.6.0.jar" />
                            <include name="vecmath1.2-1.14.jar" />
                            <include name="log4j-core.jar" />
                            <include name="log4j.jar" />
                        </fileset>
                        <fileset dir="${dist}/jar">
                            <include name="cdk-core.jar" />
                        </fileset>
                    </classpath>
                </javac>
        </target>

        <target name="compile-io" depends="init, dist-core, dist-standard">
                <echo message="Compiling classes for cdk-io module." />

                <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}">
                    <include name="org/openscience/cdk/io/**/*"/>
                    <include name="org/openscience/cdk/ChemFile.java"/>
                    <include name="org/openscience/cdk/exception/UnsupportedChemObjectException.java"/>

                    <classpath refid="project.class.path" />
                    <classpath>
                        <fileset dir="${dist}/jar">
                            <include name="cdk-core.jar" />
                            <include name="cdk-standard.jar" />
                        </fileset>
                    </classpath>
                </javac>
        </target>

        <target name="compile-render" depends="init, dist-core, dist-standard">
                <echo message="Compiling classes for cdk-render module." />

                <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}">
                    <include name="org/openscience/cdk/renderer/**/*"/>
                    <include name="org/openscience/cdk/controller/**/*"/>
                    <excludesfile name="${src}/java3d.classes"/>

                    <classpath refid="project.class.path" />
                    <classpath>
                        <fileset dir="${dist}/jar">
                            <include name="cdk-core.jar" />
                            <include name="cdk-standard.jar" />
                        </fileset>
                    </classpath>
                </javac>
        </target>

        <target name="compile-extra" depends="dist-standard">
            <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                   debug="${debug}" deprecation="${deprecation}">
                <classpath refid="project.class.path" />

		<excludesfile name="${src}/java3d.classes" />
                <exclude name="org/openscience/cdk/libio/**/*.java" />
                <exclude name="org/openscience/cdk/test/**/*.java" />
                <exclude name="org/openscience/cdk/applications/**/*.java" />
            </javac>          
        </target>

        <target name="compile-cml">
            <!-- Task to build the CML Lib classes. (For Jmol) -->
            <echo message="Compiling classes defined in ${src}/cml.classes." />

            <!-- apply patch to remove dependency on Log4J -->
            <patch patchfile="${src}/patches/org.openscience.cdk.toold.LoggingTool.java.MakeUsableInJmolApplet"
                   originalfile="${build.src}/org/openscience/cdk/tools/LoggingTool.java"
                   dir="${build.src}/org/openscience/cdk/tools"/>

            <javac srcdir="${build.src}" destdir="${build}" optimize="${optimization}" 
                   debug="${debug}" deprecation="${deprecation}"
                   includesfile="${src}/cml.classes">
                <classpath refid="project.class.path" />
            </javac>

            <!-- delete file="${build.src}/org/openscience/cdk/tools/LoggingTool.java"/ -->
        </target>

        <target name="compile-test" depends="compile">
                <!-- Task to build the test classes. -->
                <javac srcdir="${build.src}/org/openscience/cdk/test"
                       destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}">
                        <exclude name="renderer/Accel*.java" />
                        <exclude name="renderer/Orbitals*.java" />
                        <exclude name="libio/**/*.java" />
                        <exclude name="math/qm/VisualGaussiansCalculationTest.java" />
                        <exclude name="io/ZMatrixReaderTest.java" />

                        <classpath refid="project.class.path" />
                </javac>
        </target>

        <target name="compile-render-with-java3d" depends="compile-render">
                <mkdir dir="${build}" />

                <javac destdir="${build}" optimize="${optimization}" 
                       debug="${debug}" deprecation="${deprecation}"
                       includesfile="${src}/java3d.classes">

                        <classpath refid="project.class.path" />
                </javac>
        </target>

        <target name="dist.init">
                <mkdir dir="${dist}/jar" />

                <mkdir
                dir="${build}/org/openscience/cdk/config" />

                <copy
                file="${src}/org/openscience/cdk/config/isotopes.xml"
                tofile="${build}/org/openscience/cdk/config/isotopes.xml" />
                <copy
                file="${src}/org/openscience/cdk/config/structgen_atomtypes.xml"
                tofile="${build}/org/openscience/cdk/config/structgen_atomtypes.xml" />
                <copy
                file="${src}/org/openscience/cdk/config/log4j.properties"
                tofile="${build}/org/openscience/cdk/config/log4j.properties" />

                <mkdir
                dir="${build}/org/openscience/cdk/io/cml/data" />

                <copy
                file="${src}/org/openscience/cdk/io/cml/data/cml1_0.dtd"
                tofile="${build}/org/openscience/cdk/io/cml/data/cml1_0.dtd" />
                <copy
                file="${src}/org/openscience/cdk/io/cml/data/cml1_0_1.dtd"
                tofile="${build}/org/openscience/cdk/io/cml/data/cml1_0_1.dtd" />
        </target>

        <target name="dist-core" depends="compile-core, dist.init">
                <jar jarfile="${dist}/jar/cdk-core.jar">
                    <fileset dir="${build}">
                        <!-- As proposed in CDK-RFC 2 -->
                        <include name="org/openscience/cdk/AtomContainer.class" />
                        <include name="org/openscience/cdk/AtomEnumeration.class" />
                        <include name="org/openscience/cdk/Atom.class" />
                        <include name="org/openscience/cdk/AtomType.class" />
                        <include name="org/openscience/cdk/BioPolymer.class" />
                        <include name="org/openscience/cdk/Bond.class" />
                        <include name="org/openscience/cdk/CDKConstants.class" />
                        <include name="org/openscience/cdk/ChemModel.class" />
                        <include name="org/openscience/cdk/ChemObject.class" />
                        <include name="org/openscience/cdk/ChemObjectListener.class" />
                        <include name="org/openscience/cdk/ChemSequence.class" />
                        <include name="org/openscience/cdk/ElectronContainer.class" />
                        <include name="org/openscience/cdk/Element.class" />
                        <include name="org/openscience/cdk/event/ChemObjectChangeEvent.class" />
                        <include name="org/openscience/cdk/exception/CDKException.class" />
                        <include name="org/openscience/cdk/exception/NoSuchAtomException.class" />
                        <include name="org/openscience/cdk/Isotope.class" />
                        <include name="org/openscience/cdk/Molecule.class" />
                        <include name="org/openscience/cdk/Monomer.class" />
                        <include name="org/openscience/cdk/Polymer.class" />
                        <include name="org/openscience/cdk/Ring.class" />
                        <include name="org/openscience/cdk/RingSet.class" />
                        <include name="org/openscience/cdk/SetOfMolecules.class" />
                        <!-- Added after CDK-RFC 2 -->
                        <include name="org/openscience/cdk/Crystal.class" />
                        <include name="org/openscience/cdk/LonePair.class" />
                   </fileset>
                </jar>
        </target>

        <target name="dist-extra" depends="dist-core, compile-extra">
                <jar jarfile="${dist}/jar/cdk-extra.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/**/**" />
                        <!-- Exclude core classes -->
                        <exclude name="org/openscience/cdk/AtomContainer.class" />
                        <exclude name="org/openscience/cdk/AtomEnumeration.class" />
                        <exclude name="org/openscience/cdk/Atom.class" />
                        <exclude name="org/openscience/cdk/AtomType.class" />
                        <exclude name="org/openscience/cdk/BioPolymer.class" />
                        <exclude name="org/openscience/cdk/Bond.class" />
                        <exclude name="org/openscience/cdk/CDKConstants.class" />
                        <exclude name="org/openscience/cdk/ChemModel.class" />
                        <exclude name="org/openscience/cdk/ChemObject.class" />
                        <exclude name="org/openscience/cdk/ChemObjectListener.class" />
                        <exclude name="org/openscience/cdk/ChemSequence.class" />
                        <exclude name="org/openscience/cdk/ElectronContainer.class" />
                        <exclude name="org/openscience/cdk/Element.class" />
                        <exclude name="org/openscience/cdk/event/ChemObjectChangeEvent.class" />
                        <exclude name="org/openscience/cdk/exception/CDKException.class" />
                        <exclude name="org/openscience/cdk/exception/NoSuchAtomException.class" />
                        <exclude name="org/openscience/cdk/Isotope.class" />
                        <exclude name="org/openscience/cdk/Molecule.class" />
                        <exclude name="org/openscience/cdk/Monomer.class" />
                        <exclude name="org/openscience/cdk/Polymer.class" />
                        <exclude name="org/openscience/cdk/Ring.class" />
                        <exclude name="org/openscience/cdk/RingSet.class" />
                        <exclude name="org/openscience/cdk/SetOfMolecules.class" />
                        <!-- Exclude classes in cdk-io module-->
                        <exclude name="org/openscience/cdk/io/**" />
                        <!-- Exclude classes in cdk-render module-->
                        <exclude name="org/openscience/cdk/renderer/**" />
                        <exclude name="org/openscience/cdk/controller/**" />
                        <!-- Exclude libio classes -->
                        <exclude name="org/openscience/cdk/libio/**" />
                        <exclude name="org/openscience/cdk/test/libio/**" />
                        <!-- Exclude application classes -->
                        <exclude name="org/openscience/cdk/applications/**" />
                        <!-- Exclude test classes -->
                        <exclude name="org/openscience/cdk/test/**" />
                        <!-- Exclude classes in cdk-standard module-->
                        <exclude name="org/openscience/cdk/tools/LoggingTool.class" />
                        <exclude name="org/openscience/cdk/tools/IsotopeFactory.class" />
                        <exclude name="org/openscience/cdk/geometry/GeometryTools.class" />
                        <exclude name="org/openscience/cdk/geometry/CrystalGeometryTools.class" />
                        <exclude name="org/openscience/cdk/renderer/color/AtomColorer.class" />
                        <exclude name="org/openscience/cdk/renderer/color/CDKAtomColors.class" />
                        <exclude name="org/openscience/cdk/renderer/color/PartialAtomicChargeColors.class" />
                        <exclude name="org/openscience/cdk/config/**" />
                   </fileset>
                </jar>
        </target>

        <target name="dist-apps" depends="compile-apps">
                <jar jarfile="${dist}/jar/cdk-apps.jar" manifest="${src}/cdk-apps.manifest">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/applications/**" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-test" depends="dist-all, compile-test">
                <jar jarfile="${dist}/jar/cdk-test.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/test/**" />
                    </fileset>
                    <fileset dir=".">
                        <include name="data/**" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-libio" depends="compile-libio" unless="libio.present">
                <jar jarfile="${dist}/jar/cdk-libio.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/libio/**" />
                        <include name="org/openscience/cdk/test/libio/**" />
                    </fileset>
                    <fileset dir="${build}">
                        <include name="org/openscience/jmol/**" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-cml" depends="dist-core, compile-cml">
                <jar jarfile="${dist}/jar/cdk-cml.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/io/cml/**" />
                        <include name="org/openscience/cdk/io/cml/cdopi/**" />
                        <include name="org/openscience/cdk/tools/LoggingTool*" />
                        <include name="org/openscience/cdk/io/cml/data/**" />
                        <include name="org/openscience/cdk/config/log4j.properties" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-io" depends="compile-io">
                <jar jarfile="${dist}/jar/cdk-io.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/io/**/*" />
                        <include name="org/openscience/cdk/ChemFile.class" />
                        <include name="org/openscience/cdk/exception/UnsupportedChemObjectException.class" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-render" depends="compile-render">
                <jar jarfile="${dist}/jar/cdk-render.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/renderer/**/*" />
                        <include name="org/openscience/cdk/controller/**/*" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-render-with-java3d" depends="compile-render-with-java3d">
                <jar jarfile="${dist}/jar/cdk-render-java3d.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/controller/**/*" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-standard" depends="compile-standard, dist.init">
                <jar jarfile="${dist}/jar/cdk-standard.jar">
                    <fileset dir="${build}">
                        <include name="org/openscience/cdk/tools/LoggingTool.class" />
                        <include name="org/openscience/cdk/tools/IsotopeFactory.class" />
                        <include name="org/openscience/cdk/geometry/GeometryTools.class" />
                        <include name="org/openscience/cdk/geometry/CrystalGeometryTools.class" />
                        <include name="org/openscience/cdk/renderer/color/AtomColorer.class" />
                        <include name="org/openscience/cdk/renderer/color/CDKAtomColors.class" />
                        <include name="org/openscience/cdk/renderer/color/PartialAtomicChargeColors.class" />
                        <include name="org/openscience/cdk/config/**" />
                    </fileset>
                </jar>
        </target>

        <target name="dist-all" depends="dist-core, dist-standard, 
                                         dist-io, dist-render, 
                                         dist-extra" />

        <target name="dist" depends="dist-all" />

        <target name="sourcedist" depends="init">
                <copy todir="${sourcedist}">
                        <fileset dir="." includes="**/*java" />
                        <fileset dir="." includes="build.xml" />
                </copy>
                <copy todir="${sourcedist}/org/openscience/cdk/config/isotopes.xml">
                        <fileset dir="${src}/org/openscience/cdk/config/"
                                 includes="*" />
                </copy>
                <tar tarfile="cdk-source-${DSTAMP}.tar"
                basedir="${sourcedist}" includes="**" />
                <gzip zipfile="cdk-source-${DSTAMP}.tar.gz"
                src="cdk-source-${DSTAMP}.tar" />
                <delete file="cdk-source-${DSTAMP}.tar" />
                <zip zipfile="cdk-source-${DSTAMP}.zip"
                basedir="${sourcedist}" includes="**" />
        </target>

	<target name="test-core" depends="dist-core, dist-test">
            <junit printsummary="yes" haltonfailure="yes">
                <classpath refid="project.class.path" />
                <classpath>
                    <fileset dir="${dist}/jar">
                        <include name="cdk-core.jar" />
                        <include name="cdk-test.jar" />
                    </fileset>
                </classpath>

                <test name="org.openscience.cdk.test.CoreClassesTests"
                      haltonfailure="no" todir="${reports.tests}"
                      outfile="result.core">
                    <formatter type="brief" />
                </test>
            </junit>
        </target>
	
	<target name="test-standard" depends="dist-core, dist-standard, dist-test">
            <junit printsummary="yes" haltonfailure="yes">
                <classpath refid="project.class.path" />
                <classpath>
                    <fileset dir="${dist}/jar">
                        <include name="cdk-core.jar" />
                        <include name="cdk-standard.jar" />
                        <include name="cdk-test.jar" />
                    </fileset>
                </classpath>

                <test name="org.openscience.cdk.test.StandardClassesTests"
                      haltonfailure="no" todir="${reports.tests}"
                      outfile="result.standard">
                    <formatter type="brief" />
                </test>
            </junit>
        </target>
	
	<target name="test-io" depends="dist-core, dist-standard, dist-test, dist-io">
            <junit printsummary="yes" haltonfailure="yes">
                <classpath refid="project.class.path" />
                <classpath>
                    <fileset dir="${dist}/jar">
                        <include name="cdk-core.jar" />
                        <include name="cdk-standard.jar" />
                        <include name="cdk-io.jar" />
                        <include name="cdk-test.jar" />
                    </fileset>
                </classpath>

                <test name="org.openscience.cdk.test.io.IOTests"
                      haltonfailure="no" todir="${reports.tests}"
                      outfile="result.io">
                    <formatter type="brief" />
                </test>
            </junit>
        </target>

        <target name="test" depends="dist-all, dist-test">
                <junit printsummary="yes" haltonfailure="yes">
                        <classpath>
                                <pathelement path="${java.class.path}" />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                                <fileset dir="${dist}/jar">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                        <test name="org.openscience.cdk.test.CDKTests"
                        haltonfailure="no"
                        todir="${reports.tests}"
                        outfile="result">
                                <formatter type="brief" />
                        </test>
                </junit>
        </target>

        <target name="test-libio" depends="dist-libio">
                <java classname="org.openscience.cdk.test.libio.joelib.JOELibIOTest" fork="yes">
                        <classpath>
                                <pathelement location="${dist}/jar/cdk-core.jar" />
                                <pathelement location="${dist}/jar/cdk-extra.jar" />
                                <pathelement location="${dist}/jar/cdk-libio.jar" />
                                <pathelement path="${java.class.path}" />
                                <pathelement location="." />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                                <fileset dir="${lib}/libio">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                </java>
        </target>

        <target name="run-with-java3d"
        depends="dist-extra, dist-io, dist-extra, dist-render-with-java3d">
                <java
                classname="org.openscience.cdk.test.OrbitalsRenderer3DTest"
                 fork="yes">
                        <arg value="data/reserpine.mol" />

                        <classpath>
                                <pathelement location="${dist}/jar/cdk-core.jar" />
                                <pathelement location="${dist}/jar/cdk-standard.jar" />
                                <pathelement location="${dist}/jar/cdk-extra.jar" />
                                <pathelement location="${dist}/jar/cdk-io.jar" />
                                <pathelement location="${dist}/jar/cdk-render.jar" />
                                <pathelement location="${dist}/jar/cdk-render-with-java3d.jar" />
                                <pathelement path="${java.class.path}" />
                                <pathelement location="." />
                                <fileset dir="${lib}">
                                        <include name="*.jar" />
                                </fileset>
                                <fileset dir="${pathto3djava}">
                                        <include name="*.jar" />
                                </fileset>
                        </classpath>
                </java>
        </target>

        <target name="run" depends="dist-core, dist-extra, dist-test, dist-standard">
                <java classname="org.openscience.cdk.test.tools.IsotopeFactoryTest" fork="yes">
                    <classpath>
                        <pathelement location="${dist}/jar/cdk-core.jar" />
                        <pathelement location="${dist}/jar/cdk-standard.jar" />
                        <pathelement location="${dist}/jar/cdk-io.jar" />
                        <pathelement location="${dist}/jar/cdk-render.jar" />
                        <pathelement location="${dist}/jar/cdk-extra.jar" />
                        <pathelement location="${dist}/jar/cdk-apps.jar" />
                        <pathelement location="${dist}/jar/cdk-test.jar" />
                        <pathelement location="${dist}/jar/cdk-libio.jar" />
                        <pathelement path="${java.class.path}" />
                        <pathelement location="." />
                        <fileset dir="${lib}">
                                <include name="*.jar" />
                        </fileset>
                        <fileset dir="${lib}/libio">
                                <include name="*.jar" />
                        </fileset>
                    </classpath>
                </java>
        </target>

</project>
